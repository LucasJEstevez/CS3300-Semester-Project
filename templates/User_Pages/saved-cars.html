{% extends "base.html" %}

{% block title %}Buy{% endblock %}

{% block content %}
<style>
    /* Simple styling for the table */
    table
    {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        margin-left: 20px;
    }
    th, td
    {
        border: 1px solid #ddd;
        padding: 8px;
    }
    th
    {
        background-color: #f2f2f2;
        font-weight: bold;
    }
</style>

<html>

<body>
<!--Row of Dropdown Menus for Car Search-->
<div class="header">
    <div class="dropdown">
        <div onclick="myFunction('yearDrop')" class="dropbtn">Year</div>
        <div id="yearDrop" class="dropdown-content">
            <input type="text" placeholder="Search.." id="yearInput" onkeyup="filterFunction('yearDrop', 'yearInput')">
            <a href="#">2023</a>
            <a href="#">2022</a>
            <a href="#">2021</a>
            <a href="#">2020</a>
            <a href="#">2019</a>
            <a href="#">2018</a>
            <a href="#">2017</a>
            <a href="#">2016</a>
            <a href="#">2015</a>
            <a href="#">2014</a>
            <a href="#">2013</a>
            <a href="#">2012</a>
            <a href="#">2011</a>
            <a href="#">2010</a>
            <a href="#">2009</a>
            <a href="#">2008</a>
            <a href="#">2007</a>
            <a href="#">2006</a>
            <a href="#">2005</a>
            <a href="#">2004</a>
            <a href="#">2003</a>
            <a href="#">2002</a>
            <a href="#">2001</a>
            <a href="#">2000</a>
            <a href="#">1999</a>
            <a href="#">1998</a>
            <a href="#">1997</a>
            <a href="#">1996</a>
            <a href="#">1995</a>
        </div>
    </div>
    <div class="dropdown">
        <div onclick="myFunction('makeDrop')" class="dropbtn">Make</div>
        <div id="makeDrop" class="dropdown-content">
            <input type="text" placeholder="Search.." id="makeInput" onkeyup="filterFunction('makeDrop', 'makeInput')">
            <a href="#" onclick="filterModels('Honda')">Honda</a>
            <a href="#" onclick="filterModels('Toyota')">Toyota</a>
            <a href="#" onclick="filterModels('Ford')">Ford</a>
            <a href="#" onclick="filterModels('Honda')">Chevrolet</a>
            <a href="#" onclick="filterModels('Toyota')">BMW</a>
            <a href="#" onclick="filterModels('Ford')">Mercedes</a>
            <a href="#" onclick="filterModels('Honda')">Audi</a>
            <a href="#" onclick="filterModels('Toyota')">Nissan</a>
            <a href="#" onclick="filterModels('Ford')">Volkswagen</a>
            <a href="#" onclick="filterModels('Honda')">Hyundai</a>
            <a href="#" onclick="filterModels('Toyota')">Kia</a>
            <a href="#" onclick="filterModels('Ford')">Mazda</a>
            <a href="#" onclick="filterModels('Honda')">Lexus</a>
            <a href="#" onclick="filterModels('Toyota')">Subaru</a>
            <a href="#" onclick="filterModels('Ford')">Jeep</a>
            <a href="#" onclick="filterModels('Honda')">Chrysler</a>
            <a href="#" onclick="filterModels('Toyota')">Volvo</a>
            <a href="#" onclick="filterModels('Ford')">Acura</a>
            <a href="#" onclick="filterModels('Honda')">Lincoln</a>
            <a href="#" onclick="filterModels('Toyota')">Dodge</a>
        </div>
    </div>
    <div class="dropdown">
        <div onclick="myFunction('modelDrop')" class="dropbtn">Model</div>
        <div id="modelDrop" class="dropdown-content">
            <input type="text" placeholder="Search.." id="modelInput" onkeyup="filterFunction('modelDrop', 'modelInput')">
              <!-- Toyota -->
              <a href="#" data-make="Toyota">Corolla</a>
              <a href="#" data-make="Toyota">Camry</a>
              <a href="#" data-make="Toyota">Prius</a>
              <a href="#" data-make="Toyota">RAV4</a>
              <a href="#" data-make="Toyota">4Runner</a>
              <a href="#" data-make="Toyota">Highlander</a>
              <a href="#" data-make="Toyota">Land Cruiser</a>
              <a href="#" data-make="Toyota">Tacoma</a>
              <a href="#" data-make="Toyota">Avalon</a>

              <!-- Honda -->
              <a href="#" data-make="Honda">Civic</a>
              <a href="#" data-make="Honda">Accord</a>
              <a href="#" data-make="Honda">CR-V</a>
              <a href="#" data-make="Honda">Pilot</a>
              <a href="#" data-make="Honda">HR-V</a>
              <a href="#" data-make="Honda">Integra</a>

              <!-- Ford -->
              <a href="#" data-make="Ford">Fiesta</a>
              <a href="#" data-make="Ford">Mustang</a>
              <a href="#" data-make="Ford">Explorer</a>
              <a href="#" data-make="Ford">F-150</a>
              <a href="#" data-make="Ford">Focus</a>
              <a href="#" data-make="Ford">Escape</a>
              <a href="#" data-make="Ford">Ranger</a>
              <a href="#" data-make="Ford">Taurus</a>

              <!-- Chevrolet -->
              <a href="#" data-make="Chevrolet">Malibu</a>
              <a href="#" data-make="Chevrolet">Impala</a>
              <a href="#" data-make="Chevrolet">Equinox</a>
              <a href="#" data-make="Chevrolet">Tahoe</a>
              <a href="#" data-make="Chevrolet">Suburban</a>
              <a href="#" data-make="Chevrolet">Silverado</a>

              <!-- BMW -->
              <a href="#" data-make="BMW">3 Series</a>
              <a href="#" data-make="BMW">5 Series</a>
              <a href="#" data-make="BMW">X5</a>
              <a href="#" data-make="BMW">X3</a>

              <!-- Mercedes -->
              <a href="#" data-make="Mercedes">C-Class</a>
              <a href="#" data-make="Mercedes">E-Class</a>
              <a href="#" data-make="Mercedes">GLE</a>
              <a href="#" data-make="Mercedes">GLA</a>
              <a href="#" data-make="Mercedes">S-Class</a>

              <!-- Audi -->
              <a href="#" data-make="Audi">A4</a>
              <a href="#" data-make="Audi">A6</a>
              <a href="#" data-make="Audi">Q5</a>
              <a href="#" data-make="Audi">Q7</a>

              <!-- Nissan -->
              <a href="#" data-make="Nissan">Altima</a>
              <a href="#" data-make="Nissan">Maxima</a>
              <a href="#" data-make="Nissan">Rogue</a>
              <a href="#" data-make="Nissan">Murano</a>
              <a href="#" data-make="Nissan">Pathfinder</a>
              <a href="#" data-make="Nissan">Frontier</a>

              <!-- Volkswagen -->
              <a href="#" data-make="Volkswagen">Golf</a>
              <a href="#" data-make="Volkswagen">Passat</a>
              <a href="#" data-make="Volkswagen">Tiguan</a>
              <a href="#" data-make="Volkswagen">Atlas</a>
              <a href="#" data-make="Volkswagen">Jetta</a>

              <!-- Hyundai -->
              <a href="#" data-make="Hyundai">Elantra</a>
              <a href="#" data-make="Hyundai">Sonata</a>
              <a href="#" data-make="Hyundai">Tucson</a>
              <a href="#" data-make="Hyundai">Santa Fe</a>

              <!-- Kia -->
              <a href="#" data-make="Kia">Forte</a>
              <a href="#" data-make="Kia">K5</a>
              <a href="#" data-make="Kia">Sorento</a>
              <a href="#" data-make="Kia">Rio</a>

              <!-- Mazda -->
              <a href="#" data-make="Mazda">MX5</a>
              <a href="#" data-make="Mazda">CX-50</a>
              <a href="#" data-make="Mazda">CX-5</a>
              <a href="#" data-make="Mazda">CX-90</a>
              <a href="#" data-make="Mazda">3</a>

              <!-- Lexus -->
              <a href="#" data-make="Lexus">ES300</a>
              <a href="#" data-make="Lexus">GS</a>
              <a href="#" data-make="Lexus">GS350</a>
              <a href="#" data-make="Lexus">ES</a>
              <a href="#" data-make="Lexus">LS</a>
              <a href="#" data-make="Lexus">RX</a>

              <!-- Subaru -->
              <a href="#" data-make="Subaru">Outback</a>
              <a href="#" data-make="Subaru">Forester</a>
              <a href="#" data-make="Subaru">WRX</a>

              <!-- Jeep -->
              <a href="#" data-make="Jeep">Grand Cherokee</a>
              <a href="#" data-make="Jeep">Wrangler</a>

              <!-- Chrysler -->
              <a href="#" data-make="Chrysler">300</a>

              <!-- Volvo -->
              <a href="#" data-make="Volvo">XC90</a>

              <!-- Acura -->
              <a href="#" data-make="Acura">TL</a>

              <!-- Lincoln -->
              <a href="#" data-make="Lincoln">Navigator</a>

              <!-- Dodge -->
              <a href="#" data-make="Dodge">Durango</a>
        </div> 
    </div>  
    <br>
    <h2 id="welcome_header" style="background-color: black;"></h2>
        </div>
        </div>
</div>

<!--<script src="../../static/CSS_Files/javafile.js"></script>-->

<div id="tableContainer"></div>

<!-- Load PapaParse from local file -->
<script src="../../static/PapaParse/papaparse.js"></script>

<!-- Check if user is logged in -->
<script>
    window.onload = function() {
        const token = localStorage.getItem("access_token");
        let loggedIn = false;

        if (token) {
            fetch('/isValidToken', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ token: token }) // Send token only in body
            })
            .then(response => {
                if (!response.ok) {
                    // If the response is not ok, throw an error
                    return response.text().then(text => {
                        throw new Error(`HTTP error! status: ${response.status} - ${text}`);
                    });
                }
                return response.json(); // Parse the JSON if response is ok
            })
            .then(data => {
                if (data.isValid) {
                    loggedIn = true;
                    document.getElementById("welcome_header").innerHTML = `Welcome, ${data.username}!`;
                    
                    // Change sign-in button to saved cars
                    var signin_button = document.getElementById("sign-in_button");
                    signin_button.innerHTML = 'Saved Cars';
                    signin_button.href = "/saved-cars";

                    //Change register button to sign-out
                    var register_button = document.getElementById("register_button");
                    register_button.innerHTML = 'Sign Out';
                    register_button.removeAttribute('href');
                    register_button.onclick = signOut;

                    getSavedCars()
                } else {
                    document.getElementById("welcome_header").innerHTML = 'Invalid token or user not found.';
                }
            })
            .catch(error => {
                console.error('Error during request:', error);
                document.getElementById("welcome_header").innerHTML = 'Request failed: ' + error.message;
            });
        } else {
            document.getElementById("welcome_header").innerHTML = 'No token found. Must be logged in to sell your car.';
            window.location.href = "/sign-in";
        }
    
        
    }

    function signOut(){
        localStorage.removeItem("access_token");
        window.location.href = "/";
    }
</script>

<!--Get id numbers of saved cars-->>
<script>
function getSavedCars() {
    const token = localStorage.getItem("access_token");
    let loggedIn = false;

    if (token) {
        fetch('/getSavedCars', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ token: token })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.isValid) {
                if(!data.error){
                    //This is a placeholder
                    //console.log(data.carIdArray);
                    console.log("Array in getSavedCars:", data.carIdArray);
                    return data.carIdArray;
                }
                else{
                    alert("There was a problem. Please try again later.")
                }
            }
        })
        .catch(error => {
            console.error('Error during request:', error);
            document.getElementById("welcome_header").innerHTML = 'Request failed: ' + error.message;
        });
    }
}
</script>

<script>
  const csvUrl = "{{url_for('static', filename='cars/site_available_cars(testing).csv')}}"; // Replace with your fixed CSV URL
  allowedVehicleIDs = getSavedCars();
  console.log(allowedVehicleIDs);

  window.addEventListener("load", function() {
  fetch(csvUrl)
      .then(response =>
      {
      if (!response.ok)
      {
          throw new Error("Network response was not ok");
      }
      return response.text();
      })
      .then(csvText =>
      {
      Papa.parse(csvText,
      {
          header: true,           // Use the first row as header
          dynamicTyping: true,    // Convert data types automatically
          worker: true,
          step: function(row)
          {
            const vehicleId = row.data.Vehicle_ID;
            console.log("Array in papa parse:", allowedVehicleIDs);

            // Check if the Vehicle_ID is in the allowed list
            for (let i = 0; i < allowedVehicleIDs.length(); i++)
            {
                if (allowedVehicleIDs[i] === vehicleId)
                {
                    originalData.push(row.data);

                    const displayRow = { ...row.data };
                    delete displayRow.Vehicle_ID;
                    buffer.push(displayRow);
                }
            }
        },

          complete: function()
          {
          console.log("CSV parsing complete.");
          console.log(allowedVehicleIDs);
          console.log(buffer);
          filterTable();
          }
      });
      })
      .catch(error =>
      {
      console.error("Error fetching the CSV file:", error);
      document.getElementById("tableContainer").innerHTML = "<p>Failed to load CSV file.</p>";
      });
  });

  function appendRow(rowData)
  {
  const tableContainer = document.getElementById("tableContainer");
  let table = tableContainer.querySelector("table");

  // Create the table if it doesn't exist yet
  if (!table)
  {
      table = document.createElement("table");
      tableContainer.appendChild(table);

      // Generate and append the header row
      const headers = Object.keys(rowData);
      const headerRow = document.createElement("tr");
      headers.forEach(header => {
      const th = document.createElement("th");
      th.textContent = header;
      headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
  }

  // Create and append a new row for the data
  const rowElement = document.createElement("tr");
  Object.values(rowData).forEach(cellData =>
  {
      const cell = document.createElement("td");
      cell.textContent = cellData !== undefined ? cellData : '';
      rowElement.appendChild(cell);
  });
  table.appendChild(rowElement);
  }

// Add event listeners to dropdown items
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".dropdown-content a").forEach(item => {
      item.addEventListener("click", function() {
          console.log("event listener reached for item:", item.textContent); //For the sake of testing
          const parentDropdown = this.closest(".dropdown-content");
          parentDropdown.querySelectorAll("a").forEach(a => a.classList.remove("selected"));
          this.classList.add("selected")
          console.log("Selected item: ", this.textContent); //Testing that the correct item is logged
          filterTable();
      });
  });
});

// // Close dropdowns when clicking outside
// window.onclick = function (event) {
//     if (!event.target.matches('.dropbtn')) {
//         const dropdowns = document.getElementsByClassName("dropdown-content");
//         for (let i = 0; i < dropdowns.length; i++) {
//             dropdowns[i].classList.remove('show');
//         }
//     }
// };

//The following code's framework was adapted and expanded upon from an initial idea from ChatGPT
  //Capture dropdown selections
  function filterTable()
  {
      console.log("filterTable called");
      
      const yearFilter = document.querySelector("#yearDrop a.selected")?.textContent || "";
      const makeFilter = document.querySelector("#makeDrop a.selected")?.textContent || "";
      const modelFilter = document.querySelector("#modelDrop a.selected")?.textContent || "";

      console.log("Year Filter:", yearFilter); //Testing that the correct values are received.
      console.log("Make Filter:", makeFilter);
      console.log("Model Filter:", modelFilter);


      const table = document.querySelector("#tableContainer table");
      const rows = table.querySelectorAll("tr:not(:first-child)"); // Skip the header row

      rows.forEach(row =>
      {
          const cells = row.querySelectorAll("td");
          const year = cells[0]?.textContent || "";  // Assuming 'Year' is the first column
          const make = cells[1]?.textContent || "";  
          const model = cells[2]?.textContent || ""; 

          // Show or hide the row based on filters
          row.style.display = 
              (yearFilter === "" || year === yearFilter) &&
              (makeFilter === "" || make === makeFilter) &&
              (modelFilter === "" || model === modelFilter)
                  ? ""
                  : "none";
      });
  }

function myFunction(dropdownId) {
  document.getElementById(dropdownId).classList.toggle("show");
}

function filterFunction(dropdownId, inputId) {
  const input = document.getElementById(inputId).value.toUpperCase();
  const dropdown = document.getElementById(dropdownId);
  const links = dropdown.getElementsByTagName("a");

  for (let i = 0; i < links.length; i++) {
      const text = links[i].textContent || links[i].innerText;
      links[i].style.display = text.toUpperCase().includes(input) ? "" : "none";
  }
}

function filterModels(make) {
  const modelDropdown = document.getElementById('modelDrop');
  const models = modelDropdown.getElementsByTagName('a');

  for (let i = 0; i < models.length; i++) {
      const modelMake = models[i].getAttribute('data-make');
      models[i].style.display = modelMake === make ? "" : "none";
  }
}

// // Close dropdowns when clicking outside
// window.onclick = function(event) {
//     if (!event.target.matches('.dropbtn')) {
//         const dropdowns = document.getElementsByClassName("dropdown-content");
//         for (let i = 0; i < dropdowns.length; i++) {
//             dropdowns[i].classList.remove('show');
//         }
//     }
// };
</script>
</body>
</html>
{% endblock %}